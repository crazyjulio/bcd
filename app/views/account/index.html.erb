<script>
  function setUpRedirect(productCode, button) {
    button.disabled = true;
    window.location.href = "/download/" + productCode + ""
    setTimeout("window.location='/account'", 3000);
    return true;
  }
</script>
<%= h1("My Account") %>
<br/>
<p>
  <%= link_to "Edit Profile", :controller => :registrations, :action => :edit %>
  <br/>
  <%= link_to "Order History", account_order_history_path %>
</p>
<br/>
<h2>Instructions I've purchased</h2>
<br/>
<br/>
If you don't see a set of instructions you've purchased, check out your
<%= "#{link_to "Order History", account_order_history_path}" %>" to see if there is a problem.
<br/>
<br/>
<% if @products.length == 0 %>
  You are not yet the proud owner of any of Brick City Depot's fine Instructions. Please visit the
  <%= "#{link_to "Store", store_path}" %>
  to rectify that.
<% else %>
  <p>
    <table class="cart_table">
      <tr>
        <th colspan="2">Model</th>
        <th>Parts Lists</th>
        <th class="pdf_bound_left">PDF</th>
        <th>Downloads Remaining</th>
      </tr>
      <% @products.each do |product_info| %>
        <tr>
          <td class="left_most_cell">
            <%= image_tag(product_info.image_url) unless product_info.image_url.nil? %>
          </td>
          <td>
            <%= "#{product_info.product.product_code} #{product_info.product.name}" %>
          </td>
          <% if product_info.product.includes_instructions? %>
            <td>
              <% if !product_info.html_list_ids.blank? %>
                <% product_info.html_list_ids.each_with_index do |hlid,index| %>
                  <%= link_to "Checklist #{index+1}", :controller => :downloads, :action => :download_parts_list, :parts_list_id => hlid %>
                  <br/>
                <% end %>
              <% end %>
              <% if !product_info.html_list_ids.blank? && !product_info.xml_list_ids.blank? %>
                <br/>
              <% end %>
              <% if !product_info.xml_list_ids.blank? %>
                <% product_info.xml_list_ids.each_with_index do |xlid,index| %>
                  <%= link_to "Bricklink XML #{index+1}", :controller => :downloads, :action => :download_parts_list, :parts_list_id => xlid %>
                  <br/>
                <% end %>
              <% end %>
            </td>
            <td class="pdf_bound_left">
              <noscript class="sad">
                Won't work if javascript is disabled
              </noscript>
              <%= tag "input", {:type => "button", :value => "Download", :class => 'add_to_cart_button', :onclick => "setUpRedirect('#{product_info.product.product_code}',this)"} %>
            </td>
            <td class="right_most_cell">
              <% if downloads_remaining(product_info.product.id) < 2 %>
                <b class="sad">#{downloads_remaining(product_info.product.id)}</b>
              <% else %>
                <%= downloads_remaining(product_info.product.id) %>
              <% end %>
            </td>
          <% else %>
            <td>N/A</td>
            <td>N/A</td>
          <% end %>
        </tr>
      <% end %>
    </table>
  </p>
<% end %>